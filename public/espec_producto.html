<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Producto - CandyyWorld</title>
<link rel="stylesheet" href="css/style.css">
<style>
.container{max-width:1200px;margin:40px auto;padding:20px}
.product-detail{display:grid;grid-template-columns:1fr 1fr;gap:40px;background:white;padding:40px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
@media(max-width:768px){.product-detail{grid-template-columns:1fr}}
.product-image{width:100%;height:auto;object-fit:contain;border-radius:8px;background:#f9f9f9;padding:20px}
.product-info h1{font-size:2rem;margin-bottom:16px;color:#111;font-family:var(--font-main)}
.product-meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;margin-bottom:20px;font-size:0.9rem}
.product-meta div{display:flex;flex-direction:column;background:#fff5f8;padding:12px;border-radius:8px;border:1px solid #ff9cb3}
.product-meta strong{color:var(--primary);margin-bottom:4px;font-weight:600;font-family:var(--font-main)}
.product-meta span{color:#111}
.product-price{font-size:2.5rem;font-weight:700;color:var(--primary);margin:20px 0;font-family:var(--font-main)}
.product-description{color:#111;line-height:1.6;margin-bottom:20px;padding:20px;background:#f9f9f9;border-radius:8px;font-family:var(--font-main)}
.quantity-selector{display:flex;align-items:center;gap:12px;margin:20px 0}
.quantity-btn{background:var(--primary);color:white;border:none;width:40px;height:40px;font-size:1.5rem;cursor:pointer;border-radius:8px;transition:0.2s;font-family:var(--font-main);font-weight:700}
.quantity-btn:hover{background:#FF8AA8;transform:scale(1.1)}
.quantity-input{width:60px;text-align:center;font-size:1.2rem;border:2px solid var(--primary);background:white;color:#111;padding:8px;border-radius:8px;font-family:var(--font-main)}
.btn-group{display:flex;flex-direction:column;gap:12px}
.btn-primary,.btn-secondary{padding:14px 24px;font-size:1rem;border-radius:8px;cursor:pointer;font-weight:600;transition:0.2s;width:100%;font-family:var(--font-main)}
.btn-primary{background:var(--primary);color:white;border:none}
.btn-primary:hover{background:#FF8AA8;transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,156,179,0.4)}
.btn-secondary{background:white;color:var(--primary);border:2px solid var(--primary)}
.btn-secondary:hover{background:#fff5f8}
.related-products{margin-top:60px}
.related-products h2{font-size:1.8rem;margin-bottom:24px;color:var(--primary);font-family:var(--font-main)}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px}
.product-card{background:white;border:1px solid #e0e0e0;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);transition:0.3s;cursor:pointer}
.product-card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.15)}
.product-card img{width:100%;height:200px;object-fit:contain;border-radius:8px;background:#f9f9f9;padding:10px}
.product-card h3{margin:12px 0 8px;font-size:1.1rem;color:#111;font-family:var(--font-main);font-weight:600}
.product-card .price{font-size:1.3rem;font-weight:700;color:var(--primary);font-family:var(--font-main)}
</style>
</head>
<body>

<header class="header">
  <div class="logo" onclick="window.location.href='index.html'">
    <img src="img/logo.png" alt="logo">
  </div>
  
  <div class="search-bar">
    <div class="field">
      <input type="text" id="searchInput">
      <label for="searchInput">¬øQu√© est√°s buscando?</label>
    </div>
    <div class="search-dropdown" id="searchDropdown">
      <div class="search-category">
        <h4>Categor√≠as</h4>
        <div id="categoryOptions"></div>
      </div>
      <div class="search-category">
        <h4>Sabores</h4>
        <div id="saborOptions"></div>
      </div>
    </div>
  </div>
  
  <nav class="nav">
    <button id="userBtn" class="btn-icon icon-only" aria-label="Usuario">
      <img src="img/person.png" alt="Usuario">
    </button>
    <button id="favoritosBtn" class="btn-icon" style="position:relative">
       ‚ù§Ô∏è Favoritos
    </button>
    <button id="cartBtn" class="btn-icon" style="position:relative">
       üõí Carrito
      <span id="cartBadge" class="cart-badge hidden">0</span>
    </button>
  </nav>
</header>

<!-- Modales -->
<div id="loginModal" class="modal-back">
  <div class="modal">
    <button class="close-btn" id="closeLoginModal">&times;</button>
    <h3>Iniciar sesi√≥n</h3>
    <div id="loginMsg" class="muted"></div>
    <form id="loginForm">
      <div class="field"><input id="loginEmail" type="email" required><label for="loginEmail">Correo</label></div>
      <div class="field"><input id="loginPassword" type="password" required><label for="loginPassword">Contrase√±a</label></div>
      <div class="field"><button class="btn" type="submit">Entrar</button></div>
    </form>
    <div class="switch">¬øNo tienes cuenta? <button id="toRegister">Crear cuenta</button></div>
  </div>
</div>

<div id="registerModal" class="modal-back">
  <div class="modal">
    <button class="close-btn" id="closeRegisterModal">&times;</button>
    <h3>Crear cuenta</h3>
    <div id="regMsg" class="muted"></div>
    <form id="registerForm">
      <div class="field"><input id="regName" type="text" required><label for="regName">Nombre completo</label></div>
      <div class="field"><input id="regEmail" type="email" required><label for="regEmail">Correo</label></div>
      <div class="field"><input id="regPassword" type="password" required><label for="regPassword">Contrase√±a</label></div>
      <div class="field"><input id="regConfirmPassword" type="password" required><label for="regConfirmPassword">Repetir Contrase√±a</label></div>
      <div class="field"><input id="regBirth" type="date" required><label for="regBirth">Fecha de nacimiento</label></div>
      <div class="field"><button class="btn" type="submit">Crear cuenta</button></div>
    </form>
    <div class="switch">¬øYa tienes cuenta? <button id="toLogin">Iniciar sesi√≥n</button></div>
  </div>
</div>

<div id="profileModal" class="modal-back profile-modal">
  <div class="modal" style="max-width:600px;max-height:85vh;overflow-y:auto">
    <button class="close-btn" id="closeProfileModal">&times;</button>
    <h3>Mi Perfil</h3>
    
    <!-- Pesta√±as -->
    <div style="display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #f0f0f0">
      <button class="profile-tab active" data-tab="info" style="flex:1;padding:12px;border:none;background:transparent;cursor:pointer;font-weight:600;color:#666;border-bottom:3px solid transparent;transition:0.2s">
        üë§ Informaci√≥n
      </button>
      <button class="profile-tab" data-tab="pedidos" style="flex:1;padding:12px;border:none;background:transparent;cursor:pointer;font-weight:600;color:#666;border-bottom:3px solid transparent;transition:0.2s">
        üì¶ Pedidos
      </button>
    </div>
    
    <!-- Tab: Informaci√≥n -->
    <div id="tabInfo" class="profile-tab-content">
      <div class="info">Nombre: <span id="userName"></span></div>
      <div class="info">Correo: <span id="userEmail"></span></div>
      <div class="info">Fecha de nacimiento: <span id="userBirth"></span></div>
      <div class="info highlight">Pedidos completados: <span id="userPedidos"></span></div>
      <div class="info" style="background:#E8F5E9;padding:12px;border-radius:8px;margin-top:12px">
        <span style="color:#2E7D32;font-weight:600;font-size:16px">‚≠ê Puntos: <span id="userPuntos">0</span></span>
        <br>
        <small style="color:#666;margin-top:6px;display:block">Descuento disponible: <span id="userDescuento" style="font-weight:600;color:#FF9EB4;font-size:14px">0%</span></small>
      </div>
    </div>
    
    <!-- Tab: Pedidos -->
    <div id="tabPedidos" class="profile-tab-content" style="display:none">
      <div id="pedidosContainer">
        <div id="pedidosList"></div>
      </div>
    </div>
    
    <!-- Botones siempre visibles -->
    <div style="margin-top:24px;padding-top:20px;border-top:2px solid #f0f0f0">
      <div class="field">
        <button class="btn ghost" id="openChangePass" style="width:100%">üîí Cambiar contrase√±a</button>
      </div>
      <div class="field">
        <button class="btn logout" id="logoutBtn" style="width:100%">üö™ Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>
</div>

<div id="changePassModal" class="modal-back">
  <div class="modal">
    <button class="close-btn" id="closeChangePass">&times;</button>
    <h3>Cambiar contrase√±a</h3>
    <div class="field"><input id="currentPassword" type="password"><label for="currentPassword">Contrase√±a actual</label></div>
    <div class="field"><input id="newPassword" type="password"><label for="newPassword">Nueva contrase√±a</label></div>
    <div class="btn-group">
      <button class="btn" id="updatePass">Actualizar</button>
      <button class="btn cancel" id="cancelPass">Cancelar</button>
    </div>
    <div id="passMsg" class="muted"></div>
  </div>
</div>

<div id="logoutConfirmModal" class="modal-back">
  <div class="modal">
    <h3>Confirmar</h3>
    <p>¬øDeseas cerrar sesi√≥n?</p>
    <div style="display:flex;justify-content:center;gap:10px;margin-top:12px">
      <button class="btn logout" id="confirmLogout">Aceptar</button>
      <button class="btn cancel" id="cancelLogout">Cancelar</button>
    </div>
  </div>
</div>

<div id="cartModal" class="modal-back cart-modal hidden">
  <div class="modal">
    <button class="close-btn" id="closeCartModal">&times;</button>
    <h3>Mi Carrito</h3>
    <div id="cartItems"></div>
    <div id="cartTotal" class="cart-total"></div>
    <button id="checkoutBtn" class="btn" style="width:100%;background:var(--primary);margin-top:20px" onclick="finalizarCompra()">
      Finalizar Compra
    </button>
  </div>
</div>

<div id="favoritosModal" class="modal-back cart-modal hidden">
  <div class="modal">
    <button class="close-btn" id="closeFavoritosModal">&times;</button>
    <h3>‚ù§Ô∏è Mis Favoritos</h3>
    <div id="favoritosItems"></div>
  </div>
</div>

<div id="envioModal" class="modal-back" style="display:none">
  <div class="modal" style="width:600px;max-height:90vh;overflow-y:auto">
    <button class="close-btn" id="closeEnvioModal">&times;</button>
    <h3>Datos de Entrega y Pago</h3>
    
    <form id="envioForm" onsubmit="event.preventDefault(); procesarCompra();">
      <h4 style="margin:16px 0 8px 0;color:var(--primary)">Datos de Entrega</h4>
      
      <div class="field">
        <input id="envioNombre" type="text" required>
        <label for="envioNombre">Nombre Completo *</label>
      </div>
      
      <div class="field">
        <input id="envioTelefono" type="tel" required>
        <label for="envioTelefono">Tel√©fono *</label>
      </div>
      
      <div class="field">
        <input id="envioDireccion" type="text" required>
        <label for="envioDireccion">Direcci√≥n *</label>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="field">
          <input id="envioCiudad" type="text" required>
          <label for="envioCiudad">Ciudad *</label>
        </div>
        
        <div class="field">
          <input id="envioEstado" type="text" required>
          <label for="envioEstado">Estado *</label>
        </div>
      </div>
      
      <div class="field">
        <input id="envioCP" type="text" required>
        <label for="envioCP">C√≥digo Postal *</label>
      </div>
      
      <div class="field">
        <textarea id="envioReferencias" rows="2"></textarea>
        <label for="envioReferencias">Referencias (opcional)</label>
      </div>
      
      <h4 style="margin:16px 0 8px 0;color:var(--primary)">M√©todo de Pago</h4>
      
      <div class="field">
        <select id="metodoPago" required onchange="toggleTarjetaFields()">
          <option value="">Selecciona un m√©todo</option>
          <option value="tarjeta">Tarjeta de Cr√©dito/D√©bito</option>
          <option value="efectivo">Efectivo</option>
          <option value="transferencia">Transferencia Bancaria</option>
        </select>
        <label for="metodoPago">M√©todo de Pago *</label>
      </div>
      
      <div id="tarjetaFields" style="display:none">
        <div class="field">
          <input id="nombreTarjeta" type="text">
          <label for="nombreTarjeta">Nombre en la Tarjeta</label>
        </div>
        
        <div class="field">
          <input id="numeroTarjeta" type="text" maxlength="16">
          <label for="numeroTarjeta">N√∫mero de Tarjeta</label>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="field">
            <input id="fechaExpiracion" type="text" placeholder="MM/AA">
            <label for="fechaExpiracion">Fecha de Expiraci√≥n</label>
          </div>
          
          <div class="field">
            <input id="cvv" type="text" maxlength="3">
            <label for="cvv">CVV</label>
          </div>
        </div>
      </div>
      
      <button type="submit" class="btn" style="width:100%;margin-top:20px;background:var(--primary)">
        Confirmar Compra
      </button>
    </form>
  </div>
</div>

<div id="notification" class="notification"></div>

<div class="container">
  <div class="product-detail">
    <div>
      <img id="productImage" class="product-image" alt="Producto">
    </div>
    
    <div class="product-info">
      <h1 id="productName"></h1>
      
      <div class="product-meta">
        <div><strong>Marca</strong><span id="productMarca"></span></div>
        <div><strong>Categor√≠a</strong><span id="productCategory"></span></div>
        <div><strong>Sabor</strong><span id="productSabor"></span></div>
        <div><strong>Pa√≠s de Origen</strong><span id="productPais"></span></div>
        <div><strong>Contenido</strong><span id="productCantidad"></span></div>
        <div><strong>Disponibles</strong><span id="productStock"></span></div>
      </div>
      
      <div class="product-price" id="productPrice"></div>
      
      <div class="product-description" id="productDescription"></div>
      
      <div class="quantity-selector">
        <button class="quantity-btn" id="decreaseBtn">‚àí</button>
        <input type="number" class="quantity-input" id="quantityInput" value="1" min="1">
        <button class="quantity-btn" id="increaseBtn">+</button>
      </div>
      
      <div class="btn-group">
        <button class="btn-primary" id="addToCartBtn">üõí A√±adir al Carrito</button>
        <button class="btn-secondary" id="addToFavoritosBtn">‚ù§Ô∏è A√±adir a Favoritos</button>
      </div>
    </div>
  </div>
  
  <!-- Productos Relacionados -->
  <div class="related-products">
    <h2>Productos Relacionados</h2>
    <div class="products-grid" id="relatedProducts"></div>
  </div>
</div>

<div id="footerContainer"></div>

<script src="cart.js"></script>
<script src="shared.js"></script>
<script>
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get('id');
let currentProduct = null;
let quantity = 1;

async function loadProduct() {
  if (!productId) {
    window.location.href = 'productos.html';
    return;
  }

  try {
    const res = await fetch('/.netlify/functions/getProductos', { method: 'POST' });
    const data = await res.json();
    
    if (!data.success) {
      showNotification('Error al cargar producto', 'error');
      return;
    }

    const product = data.products.find(p => String(p.id) === String(productId));
    
    if (!product) {
      showNotification('Producto no encontrado', 'error');
      setTimeout(() => window.location.href = 'productos.html', 2000);
      return;
    }

    currentProduct = product;
    
    document.getElementById('productName').textContent = product.nombre;
    document.getElementById('productMarca').textContent = product.marca || 'CandyyWorld';
    document.getElementById('productCategory').textContent = product.categoria || 'Dulces';
    document.getElementById('productSabor').textContent = product.sabor || 'Variado';
    document.getElementById('productPais').textContent = product.pais || 'M√©xico';
    document.getElementById('productCantidad').textContent = product.cantidad || '1 pieza';
    document.getElementById('productStock').textContent = `${product.stock || '0'} unidades`;
    document.getElementById('productPrice').textContent = `$${parseFloat(product.precio).toFixed(2)} MXN`;
    document.getElementById('productDescription').textContent = product.descripcion || 'Sin descripci√≥n disponible';
    document.getElementById('productImage').src = product.imagen;
    document.getElementById('productImage').alt = product.nombre;
    
    // Cargar productos relacionados
    loadRelatedProducts(data.products, product.categoria);
    
  } catch (err) {
    console.error(err);
    showNotification('Error de conexi√≥n', 'error');
  }
}

function loadRelatedProducts(allProducts, currentCategory) {
  const related = allProducts
    .filter(p => p.categoria === currentCategory && String(p.id) !== String(productId))
    .slice(0, 4);
  
  const container = document.getElementById('relatedProducts');
  
  if (related.length === 0) {
    container.innerHTML = '<p style="color:#999;text-align:center">No hay productos relacionados</p>';
    return;
  }
  
  container.innerHTML = related.map(prod => `
    <div class="product-card" onclick="window.location.href='espec_producto.html?id=${prod.id}'">
      <img src="${prod.imagen}" alt="${prod.nombre}">
      <h3>${prod.nombre}</h3>
      <p class="price">$${parseFloat(prod.precio).toFixed(2)}</p>
    </div>
  `).join('');
}

// Controles de cantidad
document.getElementById('decreaseBtn').addEventListener('click', () => {
  if (quantity > 1) {
    quantity--;
    document.getElementById('quantityInput').value = quantity;
  }
});

document.getElementById('increaseBtn').addEventListener('click', () => {
  quantity++;
  document.getElementById('quantityInput').value = quantity;
});

document.getElementById('quantityInput').addEventListener('change', (e) => {
  const value = parseInt(e.target.value);
  if (value >= 1) {
    quantity = value;
  } else {
    quantity = 1;
    e.target.value = 1;
  }
});

// A√±adir al carrito
document.getElementById('addToCartBtn').addEventListener('click', async () => {
  if (!currentUser) {
    showNotification('Debes iniciar sesi√≥n primero', 'error');
    setTimeout(() => window.location.href = 'index.html', 1500);
    return;
  }

  try {
    for (let i = 0; i < quantity; i++) {
      const res = await fetch('/.netlify/functions/addToCart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: currentUser.email, productId: String(currentProduct.id) })
      });
      
      const data = await res.json();
      
      if (data.success) {
        currentUser.carrito = JSON.stringify(data.carrito);
        localStorage.setItem('user', JSON.stringify(currentUser));
      }
    }
    
    showNotification(`${quantity} producto(s) a√±adido(s) al carrito`, 'success');
    if (typeof updateCartBadge === 'function') updateCartBadge();
    if (typeof updateCartBadgeGlobal === 'function') updateCartBadgeGlobal();
    quantity = 1;
    document.getElementById('quantityInput').value = 1;
    
  } catch (err) {
    console.error(err);
    showNotification('Error al a√±adir al carrito', 'error');
  }
});

// A√±adir a favoritos
document.getElementById('addToFavoritosBtn').addEventListener('click', async () => {
  if (!currentUser) {
    showNotification('Debes iniciar sesi√≥n primero', 'error');
    setTimeout(() => window.location.href = 'index.html', 1500);
    return;
  }

  try {
    const res = await fetch('/.netlify/functions/addToFavoritos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: currentUser.email, productId: String(currentProduct.id) })
    });
    
    const data = await res.json();
    
    if (data.success) {
      currentUser.favoritos = JSON.stringify(data.favoritos);
      localStorage.setItem('user', JSON.stringify(currentUser));
      showNotification(data.message, 'success');
    } else {
      showNotification(data.message, 'error');
    }
    
  } catch (err) {
    console.error(err);
    showNotification('Error al a√±adir a favoritos', 'error');
  }
});

// Funci√≥n de notificaci√≥n
function showNotification(message, type = 'success') {
  let notification = document.getElementById('notification');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'notification';
    notification.className = 'notification';
    document.body.appendChild(notification);
  }
  
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.style.display = 'block';
  
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

loadProduct();
</script>

<!-- Script de Cookies -->
<script src="cookies.js"></script>

</body>
</html>
