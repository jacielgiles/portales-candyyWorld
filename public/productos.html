<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Productos - CandyyWorld</title>
<link rel="stylesheet" href="css/style.css">
<style>
.main-content-productos {
  display: grid;
  grid-template-columns: 250px 1fr;
  gap: 30px;
  max-width: 1400px;
  margin: 28px auto;
  padding: 0 16px;
  position: relative;
}

.btn-open-filters {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 999;
  background: #FF9EB4;
  color: white;
  border: none;
  padding: 14px 24px;
  border-radius: 50px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(255, 156, 180, 0.4);
  transition: all 0.3s ease;
  font-family: var(--font-main);
}

.btn-open-filters:hover {
  background: #FF8AA8;
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(255, 156, 180, 0.6);
}

.filters-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.filters-overlay.active {
  display: block;
  opacity: 1;
}

.sidebar-filters {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  height: fit-content;
  position: sticky;
  top: 20px;
  transition: transform 0.3s ease;
}

.filters-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.btn-close-filters {
  display: none;
  background: none;
  border: none;
  font-size: 32px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  line-height: 1;
  transition: color 0.2s;
}

.btn-close-filters:hover {
  color: #FF9EB4;
}

.filter-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 20px;
}

.btn-apply-filters {
  display: none;
  width: 100%;
  padding: 12px;
  background: #FF9EB4;
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  transition: 0.2s;
  font-family: var(--font-main);
}

.btn-apply-filters:hover {
  background: #FF8AA8;
}

.sidebar-filters h3 {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 20px;
  color: #333;
  font-family: var(--font-main);
}

.filter-section {
  margin-bottom: 24px;
  padding-bottom: 20px;
  border-bottom: 1px solid #f0f0f0;
}

.filter-section:last-of-type {
  border-bottom: none;
}

.filter-section h4 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: #666;
  text-transform: uppercase;
  font-family: var(--font-main);
}

.filter-section label {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  cursor: pointer;
  font-size: 14px;
  color: #333;
  font-family: var(--font-main);
}

.filter-section input[type="checkbox"] {
  margin-right: 8px;
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.filter-select {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  font-size: 14px;
  font-family: var(--font-main);
  background: white;
  cursor: pointer;
}

.price-inputs {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.price-input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.price-input-group label {
  font-size: 12px;
  color: #666;
  font-weight: 500;
  font-family: var(--font-main);
}

.price-input-group input[type="number"] {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  font-size: 14px;
  font-family: var(--font-main);
  background: white;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.price-input-group input[type="number"]:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(255, 156, 179, 0.15);
}

.price-input-group input[type="number"]::placeholder {
  color: #999;
}

/* Quitar flechas de input number en Chrome, Safari, Edge */
.price-input-group input[type="number"]::-webkit-outer-spin-button,
.price-input-group input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Quitar flechas de input number en Firefox */
.price-input-group input[type="number"] {
  -moz-appearance: textfield;
}

.btn-clear-filters {
  width: 100%;
  padding: 10px;
  background: #f5f5f5;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  color: #666;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: 0.2s;
  font-family: var(--font-main);
  margin-top: 10px;
}

.btn-clear-filters:hover {
  background: #e0e0e0;
  color: #333;
}

.content-area-productos {
  flex: 1;
}

.filter-info{text-align:center;margin-bottom:16px;padding:10px;background:#fff5f8;border:1px solid var(--primary);border-radius:8px;color:var(--primary);font-weight:600}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px}
.product-card{background:white;border:1px solid #e0e0e0;border-radius:12px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06);transition:transform 0.2s,box-shadow 0.2s;cursor:pointer;display:flex;flex-direction:column;justify-content:space-between;min-height:380px}
.product-card:hover{transform:translateY(-4px);box-shadow:0 6px 16px rgba(0,0,0,0.12)}
.product-card img{width:100%;border-radius:8px;height:180px;object-fit:cover;margin-bottom:12px}
.product-card h3{margin:0 0 8px 0;font-size:18px;color:#333;min-height:48px;display:flex;align-items:center;justify-content:center}
.product-card p{margin:4px 0;font-size:14px;color:#555;flex:1}
.product-card .price{font-weight:bold;color:var(--primary);margin:8px 0;font-size:18px}
.product-card button{margin-top:auto;padding:10px 16px;border-radius:8px;border:none;background:var(--primary);color:white;font-weight:600;cursor:pointer;transition:0.2s;width:100%}
.product-card button:hover{background:#FF8AA8}

@media (max-width: 1024px) {
  .main-content-productos {
    grid-template-columns: 220px 1fr;
    gap: 20px;
  }
  
  .sidebar-filters {
    padding: 16px;
  }
}

@media (max-width: 768px) {
  .main-content-productos {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .btn-open-filters {
    display: block;
  }
  
  .sidebar-filters {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 300px;
    max-width: 85%;
    height: 100vh;
    overflow-y: auto;
    z-index: 1001;
    border-radius: 0;
    transform: translateX(-100%);
    box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
  }
  
  .sidebar-filters.active {
    transform: translateX(0);
  }
  
  .btn-close-filters {
    display: block;
  }
  
  .btn-apply-filters {
    display: block;
  }
  
  .filters-header h3 {
    margin: 0;
  }
  
  .products-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
}

@media (max-width: 500px) {
  .products-grid {
    grid-template-columns: 1fr;
  }
  
  .sidebar-filters h3 {
    font-size: 18px;
  }
  
  .filter-section h4 {
    font-size: 13px;
  }
  
  .sidebar-filters {
    width: 280px;
  }
}
</style>
</head>
<body>

<header class="header">
  <div class="logo" onclick="window.location.href='index.html'">
    <img src="img/logo.png" alt="logo">
  </div>
  
  <div class="search-bar">
    <div class="field">
      <input type="text" id="searchInput">
      <label for="searchInput">¬øQu√© est√°s buscando?</label>
    </div>
    <div class="search-dropdown" id="searchDropdown">
      <div class="search-category">
        <h4>Categor√≠as</h4>
        <div id="categoryOptions"></div>
      </div>
      <div class="search-category">
        <h4>Sabores</h4>
        <div id="saborOptions"></div>
      </div>
    </div>
  </div>
  
  <nav class="nav">
    <button id="userBtn" class="btn-icon icon-only" aria-label="Usuario">
      <img src="img/person.png" alt="Usuario">
    </button>
    <button id="favoritosBtn" class="btn-icon" style="position:relative">
       ‚ù§Ô∏è Favoritos
    </button>
    <button id="cartBtn" class="btn-icon" style="position:relative">
       üõí Carrito
      <span id="cartBadge" class="cart-badge hidden">0</span>
    </button>
  </nav>
</header>

<!-- Modales (copiar del index.html) -->
<div id="loginModal" class="modal-back">
  <div class="modal">
    <button class="close-btn" id="closeLoginModal">&times;</button>
    <h3>Iniciar sesi√≥n</h3>
    <div id="loginMsg" class="muted"></div>
    <form id="loginForm">
      <div class="field"><input id="loginEmail" type="email" required><label for="loginEmail">Correo</label></div>
      <div class="field"><input id="loginPassword" type="password" required><label for="loginPassword">Contrase√±a</label></div>
      <div class="field"><button class="btn" type="submit">Entrar</button></div>
    </form>
    <div class="switch">¬øNo tienes cuenta? <button id="toRegister">Crear cuenta</button></div>
  </div>
</div>

<div id="registerModal" class="modal-back">
  <div class="modal">
    <button class="close-btn" id="closeRegisterModal">&times;</button>
    <h3>Crear cuenta</h3>
    <div id="regMsg" class="muted"></div>
    <form id="registerForm">
      <div class="field"><input id="regName" type="text" required><label for="regName">Nombre completo</label></div>
      <div class="field"><input id="regEmail" type="email" required><label for="regEmail">Correo</label></div>
      <div class="field"><input id="regPassword" type="password" required><label for="regPassword">Contrase√±a</label></div>
      <div class="field"><input id="regConfirmPassword" type="password" required><label for="regConfirmPassword">Repetir Contrase√±a</label></div>
      <div class="field"><input id="regBirth" type="date" required><label for="regBirth">Fecha de nacimiento</label></div>
      <div class="field"><button class="btn" type="submit">Crear cuenta</button></div>
    </form>
    <div class="switch">¬øYa tienes cuenta? <button id="toLogin">Iniciar sesi√≥n</button></div>
  </div>
</div>

<div id="profileModal" class="modal-back profile-modal">
  <div class="modal" style="max-width:600px;max-height:85vh;overflow-y:auto">
    <button class="close-btn" id="closeProfileModal">&times;</button>
    <h3>Mi Perfil</h3>
    
    <!-- Pesta√±as -->
    <div style="display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #f0f0f0">
      <button class="profile-tab active" data-tab="info" style="flex:1;padding:12px;border:none;background:transparent;cursor:pointer;font-weight:600;color:#666;border-bottom:3px solid transparent;transition:0.2s">
        üë§ Informaci√≥n
      </button>
      <button class="profile-tab" data-tab="pedidos" style="flex:1;padding:12px;border:none;background:transparent;cursor:pointer;font-weight:600;color:#666;border-bottom:3px solid transparent;transition:0.2s">
        üì¶ Pedidos
      </button>
    </div>
    
    <!-- Tab: Informaci√≥n -->
    <div id="tabInfo" class="profile-tab-content">
      <div class="info">Nombre: <span id="userName"></span></div>
      <div class="info">Correo: <span id="userEmail"></span></div>
      <div class="info">Fecha de nacimiento: <span id="userBirth"></span></div>
      <div class="info highlight">Pedidos completados: <span id="userPedidos"></span></div>
      <div class="info" style="background:#E8F5E9;padding:12px;border-radius:8px;margin-top:12px">
        <span style="color:#2E7D32;font-weight:600;font-size:16px">‚≠ê Puntos: <span id="userPuntos">0</span></span>
        <br>
        <small style="color:#666;margin-top:6px;display:block">Descuento disponible: <span id="userDescuento" style="font-weight:600;color:#FF9EB4;font-size:14px">0%</span></small>
      </div>
    </div>
    
    <!-- Tab: Pedidos -->
    <div id="tabPedidos" class="profile-tab-content" style="display:none">
      <div id="pedidosContainer">
        <div id="pedidosList"></div>
      </div>
    </div>
    
    <!-- Botones siempre visibles -->
    <div style="margin-top:24px;padding-top:20px;border-top:2px solid #f0f0f0">
      <div class="field">
        <button class="btn ghost" id="openChangePass" style="width:100%">üîí Cambiar contrase√±a</button>
      </div>
      <div class="field">
        <button class="btn logout" id="logoutBtn" style="width:100%">üö™ Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>
</div>

<div id="changePassModal" class="modal-back">
  <div class="modal">
    <button class="close-btn" id="closeChangePass">&times;</button>
    <h3>Cambiar contrase√±a</h3>
    <div class="field"><input id="currentPassword" type="password"><label for="currentPassword">Contrase√±a actual</label></div>
    <div class="field"><input id="newPassword" type="password"><label for="newPassword">Nueva contrase√±a</label></div>
    <div class="btn-group">
      <button class="btn" id="updatePass">Actualizar</button>
      <button class="btn cancel" id="cancelPass">Cancelar</button>
    </div>
    <div id="passMsg" class="muted"></div>
  </div>
</div>

<div id="logoutConfirmModal" class="modal-back">
  <div class="modal">
    <h3>Confirmar</h3>
    <p>¬øDeseas cerrar sesi√≥n?</p>
    <div style="display:flex;justify-content:center;gap:10px;margin-top:12px">
      <button class="btn logout" id="confirmLogout">Aceptar</button>
      <button class="btn cancel" id="cancelLogout">Cancelar</button>
    </div>
  </div>
</div>

<div id="cartModal" class="modal-back cart-modal hidden">
  <div class="modal">
    <button class="close-btn" id="closeCartModal">&times;</button>
    <h3>Mi Carrito</h3>
    <div id="cartItems"></div>
    <div id="cartTotal" class="cart-total"></div>
    <button id="checkoutBtn" class="btn" style="width:100%;background:var(--primary);margin-top:20px" onclick="finalizarCompra()">
      Finalizar Compra
    </button>
  </div>
</div>

<div id="favoritosModal" class="modal-back cart-modal hidden">
  <div class="modal">
    <button class="close-btn" id="closeFavoritosModal">&times;</button>
    <h3>‚ù§Ô∏è Mis Favoritos</h3>
    <div id="favoritosItems"></div>
  </div>
</div>

<div id="envioModal" class="modal-back" style="display:none">
  <div class="modal" style="width:600px;max-height:90vh;overflow-y:auto">
    <button class="close-btn" id="closeEnvioModal">&times;</button>
    <h3>Datos de Entrega y Pago</h3>
    
    <form id="envioForm" onsubmit="event.preventDefault(); procesarCompra();">
      <h4 style="margin:16px 0 8px 0;color:var(--primary)">Datos de Entrega</h4>
      
      <div class="field">
        <input id="envioNombre" type="text" required>
        <label for="envioNombre">Nombre Completo *</label>
      </div>
      
      <div class="field">
        <input id="envioTelefono" type="tel" required>
        <label for="envioTelefono">Tel√©fono *</label>
      </div>
      
      <div class="field">
        <input id="envioDireccion" type="text" required>
        <label for="envioDireccion">Direcci√≥n *</label>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="field">
          <input id="envioCiudad" type="text" required>
          <label for="envioCiudad">Ciudad *</label>
        </div>
        
        <div class="field">
          <input id="envioEstado" type="text" required>
          <label for="envioEstado">Estado *</label>
        </div>
      </div>
      
      <div class="field">
        <input id="envioCP" type="text" required>
        <label for="envioCP">C√≥digo Postal *</label>
      </div>
      
      <div class="field">
        <textarea id="envioReferencias" rows="2"></textarea>
        <label for="envioReferencias">Referencias (opcional)</label>
      </div>
      
      <h4 style="margin:16px 0 8px 0;color:var(--primary)">M√©todo de Pago</h4>
      
      <div class="field">
        <select id="metodoPago" required onchange="toggleTarjetaFields()">
          <option value="">Selecciona un m√©todo</option>
          <option value="tarjeta">Tarjeta de Cr√©dito/D√©bito</option>
          <option value="efectivo">Efectivo</option>
          <option value="transferencia">Transferencia Bancaria</option>
        </select>
        <label for="metodoPago">M√©todo de Pago *</label>
      </div>
      
      <div id="tarjetaFields" style="display:none">
        <div class="field">
          <input id="nombreTarjeta" type="text">
          <label for="nombreTarjeta">Nombre en la Tarjeta</label>
        </div>
        
        <div class="field">
          <input id="numeroTarjeta" type="text" maxlength="16">
          <label for="numeroTarjeta">N√∫mero de Tarjeta</label>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="field">
            <input id="fechaExpiracion" type="text" placeholder="MM/AA">
            <label for="fechaExpiracion">Fecha de Expiraci√≥n</label>
          </div>
          
          <div class="field">
            <input id="cvv" type="text" maxlength="3">
            <label for="cvv">CVV</label>
          </div>
        </div>
      </div>
      
      <button type="submit" class="btn" style="width:100%;margin-top:20px;background:var(--primary)">
        Confirmar Compra
      </button>
    </form>
  </div>
</div>

<div id="notification" class="notification"></div>

<div class="main-content-productos">
  <!-- Bot√≥n para abrir filtros en m√≥vil -->
  <button class="btn-open-filters" id="openFiltersBtn" onclick="openFilters()">
    üîç Filtros
  </button>
  
  <!-- Overlay para cerrar filtros en m√≥vil -->
  <div class="filters-overlay" id="filtersOverlay" onclick="closeFilters()"></div>
  
  <aside class="sidebar-filters" id="sidebarFilters">
    <div class="filters-header">
      <h3>Filtros</h3>
      <button class="btn-close-filters" id="closeFiltersBtn" onclick="closeFilters()">&times;</button>
    </div>
    
    <div class="filter-section">
      <h4>Categor√≠a</h4>
      <div id="filterCategoria"></div>
    </div>
    
    <div class="filter-section">
      <h4>Sabor</h4>
      <div id="filterSabor"></div>
    </div>
    
    <div class="filter-section">
      <h4>Marca</h4>
      <div id="filterMarca"></div>
    </div>
    
    <div class="filter-section">
      <h4>Pa√≠s</h4>
      <div id="filterPais"></div>
    </div>
    
    <div class="filter-section">
      <h4>Precio</h4>
      <div class="price-inputs">
        <div class="price-input-group">
          <label for="minPrice">M√≠nimo</label>
          <input type="number" id="minPrice" placeholder="$0" min="0" step="10">
        </div>
        <div class="price-input-group">
          <label for="maxPrice">M√°ximo</label>
          <input type="number" id="maxPrice" placeholder="$1000" min="0" step="10">
        </div>
      </div>
    </div>
    
    <div class="filter-section">
      <h4>Ordenar por</h4>
      <select id="sortBy" class="filter-select">
        <option value="default">Recomendado</option>
        <option value="price-asc">Precio: Menor a Mayor</option>
        <option value="price-desc">Precio: Mayor a Menor</option>
        <option value="name">Nombre A-Z</option>
      </select>
    </div>
    
    <div class="filter-actions">
      <button class="btn-clear-filters" onclick="clearFilters()">Limpiar Filtros</button>
      <button class="btn-apply-filters" onclick="applyFiltersAndClose()">Aplicar Filtros</button>
    </div>
  </aside>
  
  <div class="content-area-productos">
    <div id="filterInfo" class="filter-info hidden"></div>
    <div id="productsGrid" class="products-grid"></div>
  </div>
</div>

<script src="cart.js"></script>
<script src="shared.js"></script>
<script>
const urlParams = new URLSearchParams(window.location.search);
const searchQuery = urlParams.get('search');
const categoria = urlParams.get('categoria');
const sabor = urlParams.get('sabor');
const pais = urlParams.get('pais');
const marca = urlParams.get('marca');

let allProducts = [];
let filteredProducts = [];

async function loadProducts() {
  try {
    const res = await fetch('/.netlify/functions/getProductos', { method: 'POST' });
    const data = await res.json();
    
    if (!data.success) {
      showNotification('Error al cargar productos', 'error');
      return;
    }

    allProducts = data.products;
    filteredProducts = [...allProducts];
    
    // Cargar filtros
    loadFilters();
    
    // Aplicar filtros de URL
    if (searchQuery) {
      filterBySearch(searchQuery);
    } else if (categoria) {
      // Marcar categor√≠a en filtros
      setTimeout(() => {
        const checkbox = document.querySelector(`#filterCategoria input[value="${categoria}"]`);
        if (checkbox) {
          checkbox.checked = true;
          applyFilters();
        }
      }, 100);
    } else if (sabor) {
      // Marcar sabor en filtros
      setTimeout(() => {
        const checkbox = document.querySelector(`#filterSabor input[value="${sabor}"]`);
        if (checkbox) {
          checkbox.checked = true;
          applyFilters();
        }
      }, 100);
    } else if (pais) {
      // Marcar pa√≠s en filtros
      setTimeout(() => {
        const checkbox = document.querySelector(`#filterPais input[value="${pais}"]`);
        if (checkbox) {
          checkbox.checked = true;
          applyFilters();
        }
      }, 100);
    } else if (marca) {
      // Marcar marca en filtros
      setTimeout(() => {
        const checkbox = document.querySelector(`#filterMarca input[value="${marca}"]`);
        if (checkbox) {
          checkbox.checked = true;
          applyFilters();
        }
      }, 100);
    } else {
      displayProducts(allProducts);
    }

  } catch (err) {
    console.error(err);
    showNotification('Error de conexi√≥n', 'error');
  }
}

function loadFilters() {
  // Obtener categor√≠as, sabores, marcas y pa√≠ses √∫nicos
  const categorias = [...new Set(allProducts.map(p => p.categoria))];
  const sabores = [...new Set(allProducts.map(p => p.sabor))];
  const marcas = [...new Set(allProducts.map(p => p.marca).filter(m => m))];
  const paises = [...new Set(allProducts.map(p => p.pais).filter(p => p))];
  
  // Cargar filtro de categor√≠as
  const filterCategoria = document.getElementById('filterCategoria');
  filterCategoria.innerHTML = categorias.map(cat => `
    <label>
      <input type="checkbox" value="${cat}" onchange="applyFilters()">
      ${cat}
    </label>
  `).join('');
  
  // Cargar filtro de sabores
  const filterSabor = document.getElementById('filterSabor');
  filterSabor.innerHTML = sabores.map(sab => `
    <label>
      <input type="checkbox" value="${sab}" onchange="applyFilters()">
      ${sab}
    </label>
  `).join('');
  
  // Cargar filtro de marcas
  const filterMarca = document.getElementById('filterMarca');
  filterMarca.innerHTML = marcas.map(marca => `
    <label>
      <input type="checkbox" value="${marca}" onchange="applyFilters()">
      ${marca}
    </label>
  `).join('');
  
  // Cargar filtro de pa√≠ses
  const filterPais = document.getElementById('filterPais');
  filterPais.innerHTML = paises.map(pais => `
    <label>
      <input type="checkbox" value="${pais}" onchange="applyFilters()">
      ${pais}
    </label>
  `).join('');
  
  // Configurar inputs de precio
  const minPriceInput = document.getElementById('minPrice');
  const maxPriceInput = document.getElementById('maxPrice');
  const maxPrice = Math.max(...allProducts.map(p => parseFloat(p.precio)));
  
  minPriceInput.value = 0;
  maxPriceInput.value = Math.ceil(maxPrice);
  maxPriceInput.placeholder = '$' + Math.ceil(maxPrice);
  
  minPriceInput.addEventListener('input', applyFilters);
  maxPriceInput.addEventListener('input', applyFilters);
  
  // Configurar ordenamiento
  document.getElementById('sortBy').addEventListener('change', applyFilters);
}

function applyFilters() {
  // Obtener filtros seleccionados
  const selectedCategorias = Array.from(document.querySelectorAll('#filterCategoria input:checked')).map(cb => cb.value);
  const selectedSabores = Array.from(document.querySelectorAll('#filterSabor input:checked')).map(cb => cb.value);
  const selectedMarcas = Array.from(document.querySelectorAll('#filterMarca input:checked')).map(cb => cb.value);
  const selectedPaises = Array.from(document.querySelectorAll('#filterPais input:checked')).map(cb => cb.value);
  const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
  const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
  const sortBy = document.getElementById('sortBy').value;
  
  // Filtrar productos
  filteredProducts = allProducts.filter(prod => {
    const matchCategoria = selectedCategorias.length === 0 || selectedCategorias.includes(prod.categoria);
    const matchPais = selectedPaises.length === 0 || selectedPaises.includes(prod.pais);
    const matchSabor = selectedSabores.length === 0 || selectedSabores.includes(prod.sabor);
    const matchMarca = selectedMarcas.length === 0 || selectedMarcas.includes(prod.marca);
    const precio = parseFloat(prod.precio);
    const matchPrice = precio >= minPrice && precio <= maxPrice;
    
    return matchCategoria && matchSabor && matchMarca && matchPais && matchPrice;
  });
  
  // Ordenar productos
  if (sortBy === 'price-asc') {
    filteredProducts.sort((a, b) => parseFloat(a.precio) - parseFloat(b.precio));
  } else if (sortBy === 'price-desc') {
    filteredProducts.sort((a, b) => parseFloat(b.precio) - parseFloat(a.precio));
  } else if (sortBy === 'name') {
    filteredProducts.sort((a, b) => a.nombre.localeCompare(b.nombre));
  }
  
  // Mostrar productos filtrados
  displayProducts(filteredProducts);
  
  // Actualizar info de filtros
  updateFilterInfo();
}

function updateFilterInfo() {
  const filterInfo = document.getElementById('filterInfo');
  const selectedCategorias = Array.from(document.querySelectorAll('#filterCategoria input:checked')).map(cb => cb.value);
  const selectedSabores = Array.from(document.querySelectorAll('#filterSabor input:checked')).map(cb => cb.value);
  const selectedMarcas = Array.from(document.querySelectorAll('#filterMarca input:checked')).map(cb => cb.value);
  const selectedPaises = Array.from(document.querySelectorAll('#filterPais input:checked')).map(cb => cb.value);
  
  if (selectedCategorias.length > 0 || selectedSabores.length > 0 || selectedMarcas.length > 0 || selectedPaises.length > 0) {
    let infoText = '';
    if (selectedCategorias.length > 0) infoText += `Categor√≠as: ${selectedCategorias.join(', ')}`;
    if (selectedSabores.length > 0) infoText += (infoText ? ' | ' : '') + `Sabores: ${selectedSabores.join(', ')}`;
    if (selectedMarcas.length > 0) infoText += (infoText ? ' | ' : '') + `Marcas: ${selectedMarcas.join(', ')}`;
    if (selectedPaises.length > 0) infoText += (infoText ? ' | ' : '') + `Pa√≠ses: ${selectedPaises.join(', ')}`;
    filterInfo.textContent = infoText;
    filterInfo.classList.remove('hidden');
  } else {
    filterInfo.classList.add('hidden');
  }
}

function clearFilters() {
  // Limpiar checkboxes
  document.querySelectorAll('#filterCategoria input, #filterSabor input, #filterMarca input, #filterPais input').forEach(cb => cb.checked = false);
  
  // Resetear precio
  const maxPrice = Math.max(...allProducts.map(p => parseFloat(p.precio)));
  document.getElementById('minPrice').value = 0;
  document.getElementById('maxPrice').value = Math.ceil(maxPrice);
  
  // Resetear ordenamiento
  document.getElementById('sortBy').value = 'default';
  
  // Aplicar filtros (mostrar todos)
  applyFilters();
}

// Funciones para abrir/cerrar filtros en m√≥vil
function openFilters() {
  const sidebar = document.getElementById('sidebarFilters');
  const overlay = document.getElementById('filtersOverlay');
  sidebar.classList.add('active');
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeFilters() {
  const sidebar = document.getElementById('sidebarFilters');
  const overlay = document.getElementById('filtersOverlay');
  sidebar.classList.remove('active');
  overlay.classList.remove('active');
  document.body.style.overflow = '';
}

function applyFiltersAndClose() {
  applyFilters();
  closeFilters();
}

function filterBySearch(query) {
  const filtered = allProducts.filter(p => 
    p.nombre.toLowerCase().includes(query.toLowerCase()) ||
    p.descripcion.toLowerCase().includes(query.toLowerCase())
  );
  displayProducts(filtered);
  const filterInfo = document.getElementById('filterInfo');
  filterInfo.textContent = `Resultados para: "${query}"`;
  filterInfo.classList.remove('hidden');
}

function displayProducts(products) {
  const grid = document.getElementById('productsGrid');
  
  if (products.length === 0) {
    grid.innerHTML = '<p style="text-align:center;color:#999;grid-column:1/-1">No se encontraron productos</p>';
    return;
  }

  grid.innerHTML = products.map(prod => `
    <div class="product-card" onclick="window.location.href='espec_producto.html?id=${prod.id}'">
      <img src="${prod.imagen}" alt="${prod.nombre}">
      <h3>${prod.nombre}</h3>
      <p>${prod.descripcion ? prod.descripcion.substring(0, 60) + '...' : ''}</p>
      <p class="price">$${parseFloat(prod.precio).toFixed(2)}</p>
      <button onclick="event.stopPropagation(); addToCartQuick(${prod.id})">A√±adir al Carrito</button>
    </div>
  `).join('');
}

async function addToCartQuick(productId) {
  if (!currentUser) {
    showNotification('Debes iniciar sesi√≥n primero', 'error');
    setTimeout(() => window.location.href = 'index.html', 1500);
    return;
  }

  try {
    const res = await fetch('/.netlify/functions/addToCart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: currentUser.email, productId: String(productId) })
    });
    
    const data = await res.json();
    
    if (data.success) {
      currentUser.carrito = JSON.stringify(data.carrito);
      localStorage.setItem('user', JSON.stringify(currentUser));
      if (typeof updateCartBadge === 'function') updateCartBadge();
      if (typeof updateCartBadgeGlobal === 'function') updateCartBadgeGlobal();
      showNotification('Producto a√±adido al carrito', 'success');
    } else {
      showNotification('Error al a√±adir al carrito', 'error');
    }
    
  } catch (err) {
    console.error(err);
    showNotification('Error de conexi√≥n', 'error');
  }
}

// Funci√≥n de notificaci√≥n
function showNotification(message, type = 'success') {
  let notification = document.getElementById('notification');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'notification';
    notification.className = 'notification';
    document.body.appendChild(notification);
  }
  
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.style.display = 'block';
  
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

loadProducts();
</script>

<!-- Script de Cookies -->
<script src="cookies.js"></script>

</body>
</html>
