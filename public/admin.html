<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Panel de Administraci√≥n</title>
<link rel="stylesheet" href="css/style.css">
<style>
body{background:#f4f6f8}
.admin-container{max-width:1400px;margin:40px auto;padding:20px}
.admin-header{background:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
.admin-header h1{color:var(--primary);margin:0}
.tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.tab-btn{padding:12px 24px;border:none;border-radius:8px;background:white;color:var(--text);cursor:pointer;font-weight:600;transition:0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.tab-btn.active{background:var(--primary);color:white}
.tab-content{display:none;background:white;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
.tab-content.active{display:block}
.field{margin-bottom:14px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn{padding:12px 24px;border:none;border-radius:8px;background:var(--primary);color:white;cursor:pointer;font-weight:600;transition:0.2s}
.btn:hover{background:#FF8AA8}
.users-table,.pedidos-table{width:100%;border-collapse:collapse;margin-top:20px}
.users-table th,.pedidos-table th{background:var(--primary);color:white;padding:12px;text-align:left}
.users-table td,.pedidos-table td{padding:12px;border-bottom:1px solid #e0e0e0}
.users-table tr:hover,.pedidos-table tr:hover{background:#f9f9f9}
.status-badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
.status-pendiente{background:#FFF3CD;color:#856404}
.status-entregado{background:#D4EDDA;color:#155724}
.btn-small{padding:6px 12px;font-size:12px;border-radius:6px;border:none;cursor:pointer;font-weight:600}
.btn-success{background:#4CAF50;color:white}
.btn-warning{background:#FFA726;color:white}
</style>
</head>
<body>

<header class="header">
  <div class="logo" onclick="window.location.href='index.html'" style="cursor:pointer">
    <img src="img/logo.png" alt="logo">
  </div>
  
  <div style="flex:1;text-align:center">
    <h2 style="color:#FF9EB4;margin:0">üõ†Ô∏è Panel de Administraci√≥n</h2>
  </div>
  
  <nav class="nav">
    <button class="btn-icon" onclick="window.location.href='index.html'" style="background:#FF9EB4;color:white;padding:10px 20px;border-radius:8px;font-weight:600;transition:0.2s" onmouseover="this.style.background='#FF8AA8'" onmouseout="this.style.background='#FF9EB4'">
      üè† Volver al Inicio
    </button>
  </nav>
</header>

<div class="admin-container">
  <div class="admin-header">
    <h1>üõ†Ô∏è Panel de Administraci√≥n</h1>
    <p>Bienvenido, Admin</p>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('productos')">A√±adir Producto</button>
    <button class="tab-btn" onclick="switchTab('usuarios')">Usuarios</button>
    <button class="tab-btn" onclick="switchTab('pedidos')">Pedidos</button>
    <button class="tab-btn" onclick="switchTab('eliminar')">Eliminar Productos</button>
  </div>

  <!-- Tab: A√±adir Producto -->
  <div id="tab-productos" class="tab-content active">
    <h2>A√±adir Nuevo Producto</h2>
    <form id="productForm">
      <div class="field" style="position:relative;margin-bottom:20px">
        <label for="categoria" style="position:static;transform:none;font-size:14px;font-weight:600;color:#333;margin-bottom:6px;display:block;background:transparent;padding:0">Categor√≠a *</label>
        <input type="text" id="categoria" placeholder="Ej: Dulces, Chocolates, Gomitas" required style="margin-top:0">
        <small style="color:#666;display:block;margin-top:4px">Escribe la categor√≠a que quieras</small>
      </div>

      <div class="field" style="position:relative;margin-bottom:20px">
        <label for="nombre" style="position:static;transform:none;font-size:14px;font-weight:600;color:#333;margin-bottom:6px;display:block;background:transparent;padding:0">Nombre *</label>
        <input type="text" id="nombre" placeholder="Nombre del producto" required style="margin-top:0">
      </div>

      <div class="field" style="position:relative;margin-bottom:20px">
        <label for="imagen" style="position:static;transform:none;font-size:14px;font-weight:600;color:#333;margin-bottom:6px;display:block;background:transparent;padding:0">Imagen (URL) *</label>
        <input type="url" id="imagen" placeholder="https://..." required style="margin-top:0">
      </div>

      <div class="field" style="position:relative;margin-bottom:20px">
        <label for="descripcion" style="position:static;transform:none;font-size:14px;font-weight:600;color:#333;margin-bottom:6px;display:block;background:transparent;padding:0">Descripci√≥n *</label>
        <textarea id="descripcion" rows="3" placeholder="Descripci√≥n del producto" required style="margin-top:0"></textarea>
      </div>

      <div class="row">
        <div class="field" style="position:relative;margin-bottom:20px">
          <label for="stock" style="position:static;transform:none;font-size:14px;font-weight:600;color:#333;margin-bottom:6px;display:block;background:transparent;padding:0">Stock *</label>
          <input type="number" id="stock" value="0" min="0" required style="margin-top:0">
        </div>

        <div class="field" style="position:relative;margin-bottom:20px">
          <label for="precio" style="position:static;transform:none;font-size:14px;font-weight:600;color:#333;margin-bottom:6px;display:block;background:transparent;padding:0">Precio *</label>
          <input type="number" id="precio" placeholder="Ej: 25" min="0" step="0.01" required style="margin-top:0">
        </div>
      </div>

      <div class="row">
        <div class="field" style="position:relative;margin-bottom:20px">
          <label for="pais" style="position:static;transform:none;font-size:14px;font-weight:600;color:#333;margin-bottom:6px;display:block;background:transparent;padding:0">Pa√≠s</label>
          <input type="text" id="pais" placeholder="Ej: M√©xico" value="M√©xico" style="margin-top:0">
        </div>

        <div class="field" style="position:relative;margin-bottom:20px">
          <label for="cantidad" style="position:static;transform:none;font-size:14px;font-weight:600;color:#333;margin-bottom:6px;display:block;background:transparent;padding:0">Cantidad</label>
          <input type="text" id="cantidad" placeholder="Ej: 100g" style="margin-top:0">
        </div>
      </div>

      <div class="field" style="position:relative;margin-bottom:20px">
        <label for="sabor" style="position:static;transform:none;font-size:14px;font-weight:600;color:#333;margin-bottom:6px;display:block;background:transparent;padding:0">Sabor</label>
        <input type="text" id="sabor" placeholder="Ej: Chocolate" style="margin-top:0">
      </div>

      <div class="field" style="position:relative;margin-bottom:20px">
        <label for="marca" style="position:static;transform:none;font-size:14px;font-weight:600;color:#333;margin-bottom:6px;display:block;background:transparent;padding:0">Marca *</label>
        <input type="text" id="marca" placeholder="Ej: Hershey's, Ferrero, Ricolino" required style="margin-top:0">
        <small style="color:#666;display:block;margin-top:4px">La marca del producto</small>
      </div>

      <button type="submit" class="btn">Agregar Producto</button>
    </form>
  </div>

  <!-- Tab: Usuarios -->
  <div id="tab-usuarios" class="tab-content">
    <h2>Usuarios Registrados</h2>
    <div id="usersContainer">Cargando...</div>
  </div>

  <!-- Tab: Pedidos -->
  <div id="tab-pedidos" class="tab-content">
    <h2>Gesti√≥n de Pedidos</h2>
    <div id="pedidosContainer">Cargando...</div>
  </div>

  <!-- Tab: Eliminar Productos -->
  <div id="tab-eliminar" class="tab-content">
    <h2>Eliminar Productos</h2>
    <div id="productosContainer">Cargando...</div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script src="cart.js"></script>
<script>
// Verificar que sea admin
const adminEmail = 'langosta@admin.com';
const currentUser = localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')) : null;

// Solo permitir acceso si el usuario es el admin
if (!currentUser || currentUser.email !== adminEmail) {
  alert('‚õî Acceso denegado. Solo administradores pueden acceder a esta p√°gina.');
  window.location.href = 'index.html';
}

let currentTab = 'productos';

function switchTab(tab) {
  currentTab = tab;
  
  // Actualizar botones
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Actualizar contenido
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  document.getElementById(`tab-${tab}`).classList.add('active');
  
  // Cargar datos seg√∫n la tab
  if (tab === 'usuarios') loadUsers();
  if (tab === 'pedidos') loadPedidos();
  if (tab === 'eliminar') loadProductos();
}

// A√±adir producto
document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const producto = {
    categoria: document.getElementById('categoria').value.trim(),
    nombre: document.getElementById('nombre').value.trim(),
    imagen: document.getElementById('imagen').value.trim(),
    descripcion: document.getElementById('descripcion').value.trim(),
    stock: parseInt(document.getElementById('stock').value),
    precio: parseFloat(document.getElementById('precio').value),
    pais: document.getElementById('pais').value.trim(),
    cantidad: document.getElementById('cantidad').value.trim(),
    sabor: document.getElementById('sabor').value.trim(),
    marca: document.getElementById('marca').value.trim()
  };
  
  try {
    const res = await fetch('/.netlify/functions/addProducto', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(producto)
    });
    
    const data = await res.json();
    
    if (data.success) {
      showNotification('Producto a√±adido correctamente', 'success');
      document.getElementById('productForm').reset();
    } else {
      showNotification('Error al a√±adir producto', 'error');
    }
  } catch (err) {
    console.error(err);
    showNotification('Error de conexi√≥n', 'error');
  }
});

// Cargar usuarios
async function loadUsers() {
  try {
    const res = await fetch('/.netlify/functions/getAllUsers', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ adminEmail })
    });
    
    const data = await res.json();
    
    if (data.success) {
      const container = document.getElementById('usersContainer');
      
      if (data.users.length === 0) {
        container.innerHTML = '<p>No hay usuarios registrados</p>';
        return;
      }
      
      container.innerHTML = `
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Fecha Nacimiento</th>
              <th>Carrito</th>
              <th>Favoritos</th>
            </tr>
          </thead>
          <tbody>
            ${data.users.map(user => {
              const carrito = JSON.parse(user.carrito || '[]');
              const favoritos = JSON.parse(user.favoritos || '[]');
              return `
                <tr>
                  <td>${user.id}</td>
                  <td>${user.name}</td>
                  <td>${user.email}</td>
                  <td>${user.birthdate ? new Date(user.birthdate).toLocaleDateString('es-MX') : 'N/A'}</td>
                  <td>${carrito.length} items</td>
                  <td>${favoritos.length} items</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }
  } catch (err) {
    console.error(err);
    document.getElementById('usersContainer').innerHTML = '<p>Error al cargar usuarios</p>';
  }
}

// Cargar pedidos
async function loadPedidos() {
  try {
    const res = await fetch('/.netlify/functions/getAllUsers', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ adminEmail })
    });
    
    const data = await res.json();
    
    if (data.success) {
      const container = document.getElementById('pedidosContainer');
      
      if (data.pedidos.length === 0) {
        container.innerHTML = '<p>No hay pedidos registrados</p>';
        return;
      }
      
      container.innerHTML = `
        <table class="pedidos-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Usuario</th>
              <th>Productos</th>
              <th>Fecha</th>
              <th>Direcci√≥n</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${data.pedidos.map(pedido => {
              const fecha = new Date(pedido.fecha).toLocaleDateString('es-MX');
              const direccion = pedido.direccion ? 
                `${pedido.direccion}, ${pedido.ciudad}, ${pedido.estado}` : 
                'Sin datos';
              
              return `
                <tr>
                  <td>${pedido.id}</td>
                  <td>${pedido.usuario}</td>
                  <td>${pedido.productos.length} items</td>
                  <td>${fecha}</td>
                  <td>${direccion}</td>
                  <td>
                    <span class="status-badge ${pedido.entregado ? 'status-entregado' : 'status-pendiente'}">
                      ${pedido.entregado ? '‚úì Entregado' : '‚è± Pendiente'}
                    </span>
                  </td>
                  <td>
                    ${pedido.entregado ? 
                      `<button class="btn-small btn-warning" onclick="updateStatus(${pedido.id}, false)">Marcar Pendiente</button>` :
                      `<button class="btn-small btn-success" onclick="updateStatus(${pedido.id}, true)">Marcar Entregado</button>`
                    }
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }
  } catch (err) {
    console.error(err);
    document.getElementById('pedidosContainer').innerHTML = '<p>Error al cargar pedidos</p>';
  }
}

// Actualizar estado de pedido
async function updateStatus(pedidoId, entregado) {
  try {
    const res = await fetch('/.netlify/functions/updatePedidoStatus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ adminEmail, pedidoId, entregado })
    });
    
    const data = await res.json();
    
    if (data.success) {
      showNotification('Estado actualizado correctamente', 'success');
      loadPedidos();
    } else {
      showNotification('Error al actualizar estado', 'error');
    }
  } catch (err) {
    console.error(err);
    showNotification('Error de conexi√≥n', 'error');
  }
}

// Cargar productos para eliminar
async function loadProductos() {
  try {
    const res = await fetch('/.netlify/functions/getProductos', {
      method: 'POST'
    });
    
    const data = await res.json();
    
    if (data.success) {
      const container = document.getElementById('productosContainer');
      
      if (data.products.length === 0) {
        container.innerHTML = '<p>No hay productos registrados</p>';
        return;
      }
      
      container.innerHTML = `
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Imagen</th>
              <th>Nombre</th>
              <th>Categor√≠a</th>
              <th>Precio</th>
              <th>Stock</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${data.products.map(prod => `
              <tr>
                <td>${prod.id}</td>
                <td><img src="${prod.imagen}" alt="${prod.nombre}" style="width:50px;height:50px;object-fit:cover;border-radius:8px" onerror="this.src='img/banner1.jpg'"></td>
                <td>${prod.nombre}</td>
                <td>${prod.categoria}</td>
                <td>$${prod.precio}</td>
                <td>${prod.stock}</td>
                <td>
                  <button class="btn-small" style="background:#f44336;color:white" onclick="deleteProducto(${prod.id}, '${prod.nombre.replace(/'/g, "\\'")}')">
                    üóëÔ∏è Eliminar
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
  } catch (err) {
    console.error(err);
    document.getElementById('productosContainer').innerHTML = '<p>Error al cargar productos</p>';
  }
}

// Eliminar producto
async function deleteProducto(productId, productName) {
  if (!confirm(`¬øEst√°s seguro de eliminar el producto "${productName}"?`)) {
    return;
  }
  
  try {
    const res = await fetch('/.netlify/functions/deleteProducto', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId })
    });
    
    const data = await res.json();
    
    if (data.success) {
      showNotification('Producto eliminado correctamente', 'success');
      loadProductos(); // Recargar la lista
    } else {
      showNotification(data.message || 'Error al eliminar producto', 'error');
    }
  } catch (err) {
    console.error(err);
    showNotification('Error de conexi√≥n', 'error');
  }
}

// Funci√≥n de notificaci√≥n
function showNotification(message, type = 'success') {
  let notification = document.getElementById('notification');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'notification';
    notification.className = 'notification';
    document.body.appendChild(notification);
  }
  
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.style.display = 'block';
  
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}
</script>

</body>
</html>
